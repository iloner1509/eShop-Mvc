var system={config:{pageSize:10,pageIndex:1},notify:function(t,e){$.notify(t,{clickToHide:!0,autoHide:!0,autoHideDelay:5e3,arrowShow:!0,arrowSize:5,position:"right top",elementPosition:"right top",globalPosition:"right top",style:"bootstrap",className:e,showAnimation:"slideDown",showDuration:400,hideAnimation:"slideUp",hideDuration:200,gap:2})},confirm:function(t,e){bootbox.confirm({message:t,buttons:{confirm:{label:"Đồng ý",className:"btn-success"},cancel:{label:"Hủy bỏ",className:"btn-danger"}},callback:function(t){t&&e()}})},dateFormatJson:function(t){if(!t)return"";let e=new Date(parseInt(t.substr(6))),n=e.getMonth()+1,o=e.getDate();return n<10&&(n="0"+n),o<10&&(o="0"+o),o+"/"+n+"/"+e.getFullYear()},dateTimeFormatJson(t){if(!t)return"";let e=new Date(parseInt(t.substr(6))),n=e.getMonth()+1,o=e.getDate(),a=e.getFullYear(),i=e.getHours(),r=e.getMinutes(),l=e.getSeconds();return n<10&&(n="0"+n),o<10&&(o="0"+o),i<10&&(i="0"+i),r<10&&(r="0"+r),l<10&&(l="0"+l),o+"/"+n+"/"+a+" "+i+":"+r+":"+l},startLoading:function(){$(".dv-loading").length>0&&$(".dv-loading").removeClass("hide")},stopLoading:function(){$(".dv-loading").length>0&&$(".dv-loading").addClass("hide")},getStatus:function(t){return 1===t?'<span class="badge bg-green">Kích hoạt</span>':'<span class="badge bg-red">Khóa</span>'},formatNumber:function(t,e){if(!isFinite(t))return t.toString();let n=t.toFixed(e).split(".");return n[0]=n[0].replace(/\d(?=(\d{3})+$)/g,"$&,"),n.join(".")},unflattern:function(t){let e={},n=[];for(let o=0;o<t.length;o+=1){let a=t[o];a.children=[],e[a.id]=o,null!==a.parentId?t[e[a.parentId]].children.push(a):n.push(a)}return n}};$(document).ajaxSend((function(t,e,n){if("POST"===n.type.toUpperCase()||"PUT"===n.type.toUpperCase()){var o=$("form").find("input[name='__RequestVerificationToken']").val();e.setRequestHeader("RequestVerificationToken",o)}}));var BillController=function(){var t={products:[],paymentMethods:[],billStatuses:[]};function e(){$("#hidIdM").val(0),$("#txtCustomerName").val(""),$("#txtCustomerAddress").val(""),$("#txtCustomerMessage").val(""),$("#txtCustomerMobile").val(""),$("#ddlPaymentMethod").val(""),$("#ddlBillStatus").val(""),$("#tbl-bill-detail").html("")}function n(e){var n="<select class='form-control ddlProductId'>";return $.each(t.products,(function(t,o){e===o.Id?n+=`<option value="${o.Id}" selected="select">${o.Name}</option>`:n+=`<option value="${o.Id}" >${o.Name}</option>`})),n+="</select>"}function o(e){let n=$("#table-template").html(),a="";$.ajax({type:"GET",data:{startDate:$("#txtFromDate").val(),endDate:$("#txtToDate").val(),keyword:$("#txt-search-keyword").val(),page:system.config.pageIndex,pageSize:system.config.pageSize},url:"/Admin/Bill/GetAllPaging",dataType:"json",success:function(i){i.RowCount>0?$.each(i.Results,(function(r,l){var c,s,d,u;a+=Mustache.render(n,{CustomerName:l.CustomerName,Id:l.Id,PaymentMethod:(d=l.PaymentMethod,u=$.grep(t.paymentMethods,(function(t,e){return t.Value===d})),u.length>0?u[0].Name:""),BillStatus:(c=l.BillStatus,s=$.grep(t.billStatuses,(function(t,e){return t.Value===c})),s.length>0?s[0].Name:""),CreatedDate:system.dateTimeFormatJson(l.DateCreated)}),$("#lbl-total-records").text(i.RowCount),""!==a&&$("#tbl-content").html(a),function(t,e,n){let o=Math.ceil(t/system.config.pageSize);0!==$("#paginationUL a").length&&!0!==n||($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:o,visiblePages:10,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(t,n){system.config.pageIndex=n,setTimeout(e(),200)}})}(i.RowCount,(function(){o()}),e)})):($("#lbl-total-records").text("0"),$("#tbl-content").html(""))},error:function(t){console.log(t),system.notify("Không nạp được dữ liệu","error")}})}this.initialize=function(){$.when($.ajax({type:"GET",url:"/Admin/Bill/GetBillStatus",dataType:"json",success:function(e){t.billStatuses=e;var n="";$.each(e,(function(t,e){n+=`<option value="${e.Value}">${e.Name}</option>`})),$("#ddlBillStatus").html(n)},error:function(){system.notify("Có lỗi khi load trạng thái đơn hàng","error")}}),$.ajax({type:"GET",url:"/Admin/Bill/GetPaymentMethod",dataType:"json",success:function(e){t.paymentMethods=e;var n="";$.each(e,(function(t,e){n+=`<option value="${e.Value}">${e.Name}</option>`})),$("#ddlPaymentMethod").html(n)},error:function(){system.notify("Có lỗi khi load trạng thái đơn hàng","error")}}),$.ajax({type:"GET",url:"/Admin/Product/GetAll",dataType:"json",success:function(e){t.products=e},error:function(){system.notify("Có lỗi khi load sản phẩm","error")}})).done((function(){o()})),$("#txtFromDate,#txtToDate").datepicker({autoclose:!0,format:"dd/mm/yyyy"}),$("#frmDetail").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtCustomerName:{required:!0},txtCustomerAddress:{required:!0},txtCustomerMobile:{required:!0},txtCustomerMessage:{required:!0},ddlBillStatus:{required:!0},ddlPaymentMethod:{required:!0}}}),$("#txt-search-keyword").on("keypress",(function(t){13===t.which&&o()})),$("#btnSearch").on("click",(function(){o()})),$("#ddl-show-page").on("change",(function(){system.config.pageSize=$(this).val(),system.config.pageIndex=1,o(!0)})),$("#btnCreateBill").on("click",(function(){e(),$("#modal-detail").modal("show")})),$("body").on("click",".btn-view",(function(t){t.preventDefault();let e=$(this).data("id");$.ajax({type:"GET",url:"/Admin/Bill/GetById",data:{id:e},success:function(t){$("#hidIdM").val(t.Id),$("#txtCustomerName").val(t.CustomerName),$("#txtCustomerAddress").val(t.CustomerAddress),$("#txtCustomerMobile").val(t.CustomerMobile),$("#txtCustomerMessage").val(t.CustomerMessage),$("#ddlPaymentMethod").val(t.PaymentMethod),$("#ddlBillStatus").val(t.BillStatus);var e=t.BillDetails;if(null!==t.BillDetails&&t.BillDetails.length>0){var o="",a=$("#bill-detail-template").html();$.each(e,(function(t,e){var i=n(e.ProductId);o+=Mustache.render(a,{Id:e.Id,Products:i,Quantity:e.Quantity})})),$("#tbl-bill-detail").html(o)}$("#modal-detail").modal("show")},error:function(){system.notify("Có lỗi xảy ra!","error")}})})),$("#btnSave").on("click",(function(t){if($("#frmDetail").valid()){t.preventDefault();var n=$("#hidIdM").val(),a=$("#txtCustomerName").val(),i=$("#txtCustomerAddress").val(),r=$("#txtCustomerMobile").val(),l=$("#txtCustomerMessage").val(),c=$("#ddlPaymentMethod").val(),s=$("#ddlBillStatus").val(),d=[];$.each($("#tbl-bill-detail tr"),(function(t,e){d.push({Id:$(e).data("id"),ProductId:$(e).find("select.ddlProductId").first().val(),Quantity:$(e).find("input.txtQuantity").first().val(),BillId:n})})),$.ajax({type:"POST",url:"/Admin/Bill/SaveEntity",data:{Id:n,CustomerName:a,CustomerAddress:i,CustomerMobile:r,CustomerMessage:l,PaymentMethod:c,BillStatus:s,BillDetails:d,Status:1},dataType:"json",success:function(t){system.notify("Cập nhật đơn hàng thành công","success"),$("#modal-detail").modal("hide"),e(),o(!0)},error:function(){system.notify("Có lỗi xảy ra!","error")}})}})),$("#btnAddDetail").on("click",(function(){var t=$("#bill-detail-template").html(),e=n(null),o=Mustache.render(t,{Id:0,Products:e,Quantity:0,Total:0});$("#tbl-bill-detail").append(o)})),$("body").on("click",".btn-delete-detail",(function(){$(this).parent().parent().remove()})),$("#btnExport").on("click",(function(){let t=$("#hidIdM").val();$.ajax({type:"POST",url:"/Admin/Bill/ExportExcel",data:{billId:t},success:function(t){window.location.href=t},error:function(){system.notify("Có lỗi xảy ra!","error")}})}))}},loginController=function(){var t=function(){$("#frmLogin").validate({errorClass:"red",ignore:[],lang:"vi",rules:{userName:{required:!0},password:{required:!0}}}),$("#btnLogin").on("click",(function(t){if($("#frmLogin").valid()){t.preventDefault(),function(t,e){$.ajax({type:"POST",data:{UserName:t,Password:e},dataType:"json",url:"/admin/login/signin",success:function(t){t.Success?window.location.href="/Admin/Home/Index":system.notify("Đăng nhập thất bại","error")}})}($("#txtUserName").val(),$("#txtPassword").val())}}))};this.initialize=function(){t()}},productController=function(){function t(){$("#hidIdM").val(0),$("#txtName").val(""),e(""),CKEDITOR.instances.txtContent.setData(""),$("#txtDescription").val(""),$("#txtUnit").val(""),$("#txtImage").val(""),$("#txtPrice").val(""),$("#txtOrginalPrice").val(""),$("#txtPromotionPrice").val(""),$("#txtTag").val(""),$("#txtSeoKeyword").val(""),$("#txtSeoDescription").val(""),$("#txtSeoTitle").val(""),$("#txtSeoAlias").val(""),$("#ckStatus").prop("checked",!0),$("#ckHot").prop("checked",!1),$("#ckShowHome").prop("checked",!1)}function e(t){$.ajax({url:"/Admin/Product/GetAllCategories",type:"GET",dataType:"json",async:!1,success:function(e){let n=[];$.each(e,(function(t,e){n.push({id:e.Id,text:e.Name,parentId:e.ParentId,sortOrder:e.SortOrder})}));let o=system.unflattern(n);$("#ddlCategoryId").combotree({data:o}),$("#ddlImportCategoryId").combotree({data:o}),null!=t&&$("#ddlCategoryId").combotree("setValue",t)}})}function n(t){let e=$("#table-template").html(),o="";$.ajax({type:"GET",data:{categoryId:$("#dllCategory").val(),keyword:$("#txt-search-keyword").val(),page:system.config.pageIndex,pageSize:system.config.pageSize},url:"/Admin/Product/GetAllPaging",dataType:"json",success:function(a){$.each(a.Results,(function(i,r){o+=Mustache.render(e,{Id:r.Id,Name:r.Name,Image:null===r.Image?'<img src="/admin-site/images/notfound.png" width="25">':'<img src="/admin-site/images/test.jpg" width="25">',Price:system.formatNumber(r.Price,0),CategoryName:r.ProductCategory.Name,CreatedDate:system.dateTimeFormatJson(r.DateCreated),Status:system.getStatus(r.Status)}),$("#lbl-total-records").text(a.RowCount),""!==o&&$("#tbl-content").html(o),function(t,e,n){let o=Math.ceil(t/system.config.pageSize);0!==$("#paginationUL a").length&&!0!==n||($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:o,visiblePages:10,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(t,n){system.config.pageIndex=n,setTimeout(e(),200)}})}(a.RowCount,(function(){n()}),t)}))},error:function(t){console.log(t),system.notify("Không nạp được dữ liệu","error")}})}this.initialize=function(){$.ajax({type:"GET",url:"/Admin/Product/GetAllCategories",dataType:"json",success:function(t){let e="<option value=''>Chọn danh mục</option>";$.each(t,(function(t,n){e+="<option value='"+n.Id+"'>"+n.Name+"</option>"})),$("#dllCategory").html(e)},error:function(t){console.log(t),system.notify("Không load được dữ liệu danh mục !","error")}}),n(!1),$("#frmEdit").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtName:{required:!0},ddlCategoryId:{required:!0},txtPrice:{required:!0,number:!0},txtOriginalPrice:{number:!0},txtPromotionPrice:{number:!0}}}),$("#ddl-show-page").on("change",(function(){system.config.pageSize=$(this).val(),system.config.pageIndex=1,n(!0)})),$("#btnSearch").on("click",(function(){n()})),$("#txt-search-keyword").on("keypress",(function(t){13===t.which&&n()})),$("#btnCreateProduct").on("click",(function(){t(),e(),$("#modalAddEdit").modal("show")})),$("body").on("click",".btn-edit",(function(t){t.preventDefault(),function(t){$.ajax({url:"/Admin/Product/GetById",type:"GET",data:{id:t},dataType:"json",success:function(t){let n=t;$("#hidIdM").val(n.Id),$("#txtName").val(n.Name),e(n.CategoryId),$("#txtDescription").val(n.Description),$("#txtUnit").val(n.Unit),$("#txtPrice").val(n.Price),$("#txtOriginalPrice").val(n.OriginalPrice),$("#txtPromotionPrice").val(n.PromotionPrice),$("#txtImage").val(n.Image),$("#txtTag").val(n.Tags),$("#txtSeoKeyword").val(n.SeoKeywords),$("#txtSeoDescription").val(n.SeoDescription),$("#txtSeoAlias").val(n.SeoAlias),$("#txtSeoTitle").val(n.SeoTitle),CKEDITOR.instances.txtContent.setData(n.Content),$("#ckStatus").prop("checked",1===n.Status),$("#ckHot").prop("checked",n.HotFlag),$("#ckShowHome").prop("checked",n.HomeFlag),$("#modalAddEdit").modal("show")},error:function(){system.notify("Có lỗi khi truy cập dữ liệu sản phẩm","error")}})}($(this).data("id"))})),$("body").on("click",".btn-delete",(function(t){t.preventDefault(),function(t){system.confirm("Bạn có muốn xóa ?",(function(){$.ajax({url:"/Admin/Product/Delete",type:"POST",data:{id:t},dataType:"json",success:function(){n(!0),system.notify("Xóa thành công","success")},error:function(){system.notify("Có lỗi khi xóa sản phẩm !","error")}})}))}($(this).data("id"))})),$("#btnSelectImg").on("click",(function(){$("#fileInputImage").click()})),$("#fileInputImage").on("change",(function(){let t=$(this).get(0).files,e=new FormData;for(let n=0;n<t.length;n++)e.append(t[n].name,t[n]);$.ajax({type:"POST",url:"/Admin/Upload/UploadImage",contentType:!1,processData:!1,data:e,success:function(t){$("#txtImage").val(t),system.notify("Upload ảnh thành công","success")},error:function(){system.notify("Xảy ra lỗi khi upload ảnh !","error")}})})),$("#btnSave").on("click",(function(e){if($("#frmEdit").valid()){e.preventDefault();var o=$("#hidIdM").val(),a=$("#ddlCategoryId").combotree("getValue"),i=$("#txtName").val(),r=$("#txtDescription").val(),l=$("#txtUnit").val(),c=$("#txtPrice").val(),s=$("#txtOriginalPrice").val(),d=$("#txtPromotionPrice").val(),u=$("#txtImage").val(),m=$("#txtTag").val(),p=$("#txtSeoKeyword").val(),h=$("#txtSeoDescription").val(),f=$("#txtSeoTitle").val(),g=$("#txtSeoAlias").val(),y=CKEDITOR.instances.txtContent.getData(),k=!0===$("#ckStatus").prop("checked")?1:0,v=$("#ckHot").prop("checked"),x=$("#ckShowHome").prop("checked");$.ajax({type:"POST",url:"/Admin/Product/SaveEntity",data:{Id:o,Name:i,CategoryId:a,Description:r,Unit:l,Price:c,OriginalPrice:s,PromotionPrice:d,Image:u,Tags:m,SeoKeywords:p,SeoDescription:h,SeoTitle:f,SeoAlias:g,Status:k,HomeFlag:x,HotFlag:v,Content:y},dataType:"json",success:function(){system.notify("Cập nhật thành công.","success"),$("#modalAddEdit").modal("hide"),t(),n(!0)},error:function(){system.notify("Xảy ra lỗi khi cập nhật sản phẩm !","error")}})}})),$("#btn-import").on("click",(function(){e(),$("#importExcelModal").modal("show")})),$("#btnImportExcel").on("click",(function(){for(var t=$("#choseFile").get(0).files,e=new FormData,o=0;o<t.length;o++)e.append("files",t[o]);e.append("categoryId",$("#ddlImportCategoryId").combotree("getValue")),$.ajax({url:"/Admin/Product/ImportExcel",type:"POST",data:e,processData:!1,contentType:!1,success:function(){system.notify("Cập nhật sản phẩm từ file thành công","success"),$("#importExcelModal").modal("hide"),n()}})})),$("#btn-export").on("click",(function(){$.ajax({url:"/Admin/Product/ExportExcel",type:"POST",success:function(t){system.notify("Xuất file thành công","success"),window.location.href=t},error:function(){system.notify("Có lỗi khi xuất file","error")}})})),CKEDITOR.replace("txtContent",{}),$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy((function(t){this.$element[0]===t.target||this.$element.has(t.target).length||$(t.target).closest(".cke_dialog, .cke").length||this.$element.trigger("focus")}),this))}}},productCategoryController=function(){function t(t){$.ajax({url:"/Admin/ProductCategory/GetAll",type:"GET",dataType:"json",async:!1,success:function(e){let n=[];$.each(e,(function(t,e){n.push({id:e.Id,text:e.Name,parentId:e.ParentId,sortOrder:e.SortOrder})}));let o=system.unflattern(n);$("#ddlCategoryId").combotree({data:o}),null!=t&&$("#ddlCategoryId").combotree("setValue",t)}})}function e(){$.ajax({url:"/Admin/ProductCategory/GetAll",dataType:"json",success:function(t){let n=[];$.each(t,(function(t,e){n.push({id:e.Id,text:e.Name,parentId:e.ParentId,sortOrder:e.SortOrder})}));let o=system.unflattern(n);o.sort((function(t,e){return t.sortOrder-e.sortOrder})),$("#treeProductCategory").tree({data:o,dnd:!0,onContextMenu:function(t,e){t.preventDefault(),$("#hidIdM").val(e.id),$("#contextMenu").menu("show",{left:t.pageX,top:t.pageY})},onDrop:function(t,n,o){console.log(t),console.log(n),console.log(o);let a=$(this).tree("getNode",t);if("append"===o){let t=[];$.each(a.children,(function(e,n){t.push({key:n.id,value:e})})),$.ajax({url:"/Admin/ProductCategory/UpdateParentId",type:"POST",dataType:"json",data:{sourceId:n.id,targetId:a.id,items:t},success:function(){e()}})}else"top"!==o&&"bottom"!==o||$.ajax({url:"/Admin/ProductCategory/ReOrder",type:"POST",dataType:"json",data:{sourceId:n.id,targetId:a.id},success:function(){e()}})}})}})}this.initialize=function(){e(),$("#frmEdit").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtName:{required:!0},txtOrder:{number:!0},txtHomeOrder:{number:!0}}}),$("#btnCreateCategory").off("click").on("click",(function(){t(),$("#modalAddEdit").modal("show")})),$("body").on("click","#btnEdit",(function(e){e.preventDefault();let n=$("#hidIdM").val();$.ajax({type:"GET",url:"/Admin/ProductCategory/GetById",data:{id:n},dataType:"json",beforeSend:function(){system.startLoading()},success:function(e){let n=e;$("#hidIdM").val(n.Id),$("#txtName").val(n.Name),t(n.CategoryId),$("#txtDescription").val(n.Description),$("#txtThumbnailImg").val(n.ThumbnailImage),$("#txtSeoKeyword").val(n.SeoKeyword),$("#txtSeoDescription").val(n.SeoDescription),$("#txtSeoPageTitle").val(n.SeoPageTitle),$("#txtSeoAlias").val(n.SeoAlias),$("#ckStatus").prop("checked",1===n.Status),$("#ckShowHome").prop("checked",n.HomeFlag),$("#txtOrder").val(n.SortOrder),$("#txtHomeOrder").val(n.HomeOrder),$("#modalAddEdit").modal("show"),system.stopLoading()},error:function(){system.notify("Lỗi","error"),system.stopLoading()}})})),$("body").on("click","#btnDelete",(function(t){t.preventDefault();let n=$("#hidIdM").val();system.confirm("Bạn có muốn xóa ?",(function(){$.ajax({type:"POST",url:"/Admin/ProductCategory/Delete",data:{id:n},dataType:"json",beforeSend:function(){system.startLoading()},success:function(){system.notify("Xóa thành công","success"),system.stopLoading(),e()},error:function(){system.notify("Xóa không thành công","error"),system.stopLoading()}})}))})),$("#btnSave").on("click",(function(n){if($("#frmEdit").valid()){n.preventDefault();var o=$("#hidIdM").val(),a=$("#txtName").val(),i=$("#ddlCategoryId").combotree("getValue"),r=$("#txtDescription").val(),l=$("#txtImage").val(),c=$("#txtOrder").val(),s=$("#txtHomeOrder").val(),d=$("#txtSeoKeyword").val(),u=$("#txtSeoDescription").val(),m=$("#txtSeoTitle").val(),p=$("#txtSeoAlias").val(),h=!0===$("#ckStatus").prop("checked")?1:0,f=$("#ckShowHome").prop("checked");$.ajax({url:"/Admin/ProductCategory/SaveEntity",type:"POST",dataType:"json",data:{Id:o,Name:a,ParentId:i,Description:r,HomeOrder:s,SortOrder:c,Image:l,seoKeyword:d,Status:h,HomeFlag:f,SeoDescription:u,SeoTitle:m,SeoAlias:p},beforeSend:function(){system.startLoading()},success:function(){system.notify("Cập nhật thành công.","success"),$("#modalAddEdit").modal("hide"),$("#hidIdM").val(0),$("#txtName").val(""),t(""),$("#txtDescription").val(""),$("#txtImage").val(""),$("#txtOrder").val(""),$("#txtHomeOrder").val(""),$("#txtSeoKeyword").val(""),$("#txtSeoDescription").val(""),$("#txtSeoTitle").val(""),$("#txtSeoAlias").val(""),$("#ckStatus").prop("checked",!0),$("#ckShowHome").prop("checked",!1),system.stopLoading(),e()},error:function(){system.notify("Có lỗi xảy ra !","error"),system.stopLoading()}})}return!1})),$("#btnSelectImg").on("click",(function(){$("#fileInputImage").click()})),$("#fileInputImage").on("change",(function(){let t=$(this).get(0).files,e=new FormData;for(let n=0;n<t.length;n++)e.append(t[n].name,t[n]);$.ajax({type:"POST",url:"/Admin/Upload/UploadImage",contentType:!1,processData:!1,data:e,success:function(t){$("#txtImage").val(t),system.notify("Upload ảnh thành công","success")},error:function(){system.notify("Xảy ra lỗi khi upload ảnh !","error")}})}))}},RoleController=function(){function t(e){$.ajax({type:"GET",data:{keyword:$("#txt-search-keyword").val(),page:system.config.pageIndex,pageSize:system.config.pageSize},url:"/Admin/Role/GetAllPaging",dataType:"json",success:function(n){if(n.RowCount>0){let o=$("#table-template").html(),a="";$.each(n.Results,(function(i,r){a+=Mustache.render(o,{Id:r.Id,Name:r.Name,Description:r.Description}),""!==a&&$("#tbl-content").html(a),function(t,e,n){let o=Math.ceil(t/system.config.pageSize);0!==$("#paginationUL a").length&&!0!==n||($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:o,visiblePages:10,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(t,n){system.config.pageIndex=n,setTimeout(e(),200)}})}(n.RowCount,(function(){t()}),e)}))}else $("#tbl-content").html("");$("#lbl-total-records").text(n.RowCount)},error:function(t){console.log(t),system.notify("Không nạp được dữ liệu","error")}})}this.initialize=function(){t(),function(){function e(){$("#hidIdM").val(""),$("#txtName").val(""),$("#txtDescription").val("")}$("#frmEdit").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtName:{required:!0}}}),$("#txt-search-keyword").on("keypress",(function(e){13===e.which&&(e.preventDefault(),t())})),$("#btnSearch").on("click",(function(){t()})),$("#ddl-show-page").on("change",(function(){system.config.pageSize=$(this).val(),system.config.pageIndex=1,t(!0)})),$("#btnCreateUser").on("click",(function(){e(),$("#modalAddEdit").modal("show")})),$("body").on("click",".btn-edit",(function(t){t.preventDefault();let e=$(this).data("id");$.ajax({url:"/Admin/Role/GetById",type:"GET",data:{id:e},dataType:"json",success:function(t){let e=t;$("#hidIdM").val(e.Id),$("#txtName").val(e.Name),$("#txtDescription").val(e.Description),$("#modalAddEdit").modal("show")},error:function(){system.notify("Có lỗi khi load dữ liệu !","error")}})})),$("#btnSave").on("click",(function(n){if($("#frmEdit").valid()){n.preventDefault();let o=$("#hidIdM").val(),a=$("#txtName").val(),i=$("#txtDescription").val();$.ajax({url:"/Admin/Role/SaveEntity",type:"POST",data:{Id:o,Name:a,Description:i},dataType:"json",success:function(){system.notify("Cập nhật dữ liệu thành công","success"),$("#modalAddEdit").modal("hide"),e(),t(!0)},error:function(){system.notify("Có lỗi khi cập nhật dữ liệu !","error")}})}})),$("body").on("click",".btn-delete",(function(e){e.preventDefault();let n=$(this).data("id");system.confirm("Bạn có muốn xóa ?",(function(){$.ajax({url:"/Admin/Role/Delete",type:"POST",data:{id:n},success:function(){system.notify("Xóa thành công","success"),t()},error:function(){system.notify("Có lỗi khi xóa !","error")}})}))})),$("body").on("click",".btn-grant",(function(){var t,e;$("#hidRoleIdM").val($(this).data("id")),$.when($.ajax({type:"GET",url:"/Admin/Function/GetAll",dataType:"json",success:function(t){let n=$("#result-data-function").html(),o="";$.each(t,(function(a,i){o+=Mustache.render(n,{Name:i.Name,treegridparent:null!=i.ParentId?"treegrid-parent-"+i.ParentId:"",Id:i.Id,AllowCreate:i.AllowCreate?"checked":"",AllowEdit:i.AllowEdit?"checked":"",AllowView:i.AllowView?"checked":"",AllowDelete:i.AllowDelete?"checked":"",Status:system.getStatus(i.Status)}),""!==o&&$("#list-data-function").html(o),$(".tree").treegrid(),$("#ckCheckView").on("click",(function(){$(".ckView").prop("checked",$(this).prop("checked"))})),$("#ckCheckCreate").on("click",(function(){$(".ckCreate").prop("checked",$(this).prop("checked"))})),$("#ckCheckEdit").on("click",(function(){$(".ckEdit").prop("checked",$(this).prop("checked"))})),$("#ckCheckDelete").on("click",(function(){$(".ckDelete").prop("checked",$(this).prop("checked"))})),$(".ckView").on("click",(function(){$(".ckView:checked").length===t.length?$("#ckCheckView").prop("checked",!0):$("#ckCheckView").prop("checked",!1)})),$(".ckEdit").on("click",(function(){$(".ckEdit:checked").length===t.length?$("#ckCheckEdit").prop("checked",!0):$("#ckCheckEdit").prop("checked",!1)})),$(".ckCreate").on("click",(function(){$(".ckCreate:checked").length===t.length?$("#ckCheckCreate").prop("checked",!0):$("#ckCheckCreate").prop("checked",!1)})),$(".ckDelete").on("click",(function(){$(".ckDelete:checked").length===t.length?$("#ckCheckDelete").prop("checked",!0):$("#ckCheckDelete").prop("checked",!1)})),void 0!==e&&e()}))},error:function(t){console.log(t)}})).done((t=$("#hidRoleIdM").val(),$.ajax({type:"POST",url:"/Admin/Role/ListAllFunction",dataType:"json",data:{roleId:t},success:function(t){let e=t;$.each($("#tblFunction tbody tr"),(function(t,n){$.each(e,(function(t,e){e.FunctionId===$(n).data("id")&&($(n).find(".ckView").first().prop("checked",e.CanRead),$(n).find(".ckCreate").first().prop("checked",e.CanCreate),$(n).find(".ckEdit").first().prop("checked",e.CanUpdate),$(n).find(".ckDelete").first().prop("checked",e.CanDelete))}))})),$(".ckView:checked").length===$("#tblFunction tbody tr .ckView").length?$("#ckCheckView").prop("checked",!0):$("#ckCheckView").prop("checked",!1),$(".ckCreate:checked").length===$("#tblFunction tbody tr .ckCreate").length?$("#ckCheckCreate").prop("checked",!0):$("#ckCheckCreate").prop("checked",!1),$(".ckEdit:checked").length===$("#tblFunction tbody tr .ckEdit").length?$("#ckCheckEdit").prop("checked",!0):$("#ckCheckEdit").prop("checked",!1),$(".ckDelete:checked").length===$("#tblFunction tbody tr .ckDelete").length?$("#ckCheckDelete").prop("checked",!0):$("#ckCheckDelete").prop("checked",!1)},error:function(t){console.log(t)}}))),$("#modal-grantpermission").modal("show")})),$("#btnSavePermission").off("click").on("click",(function(){let t=[];$.each($("#tblFunction tbody tr"),(function(e,n){t.push({RoleId:$("#hidRoleIdM").val(),FunctionId:$(n).data("id"),CanRead:$(n).find(".ckView").first().prop("checked"),CanCreate:$(n).find(".ckCreate").first().prop("checked"),CanUpdate:$(n).find(".ckEdit").first().prop("checked"),CanDelete:$(n).find(".ckDelete").first().prop("checked")})})),$.ajax({type:"POST",url:"/Admin/Role/SavePermission",data:{listPermission:t,roleId:$("#hidRoleIdM").val()},success:function(){system.notify("Lưu quyền thành công","success"),$("#modal-grantpermission").modal("hide")},error:function(){system.notify("Có lỗi xảy ra khi phân quyền !","error")}})}))}()}},UserController=function(){function t(t){$("#txtUserName").prop("disabled",t),$("#txtPassword").prop("disabled",t),$("#txtConfirmPassword").prop("disabled",t)}function e(){t(!1),$("#hidIdM").val(""),$("#txtFullName").val(""),o(),$("#txtUserName").val(""),$("#txtPassword").val(""),$("#txtConfirmPassword").val(""),$("#txtEmail").val(""),$("#txtPhoneNumber").val(""),$('input[name="ckRoles"]').removeAttr("checked"),$("#ckStatus").prop("checked",!0)}function n(t){$.ajax({type:"GET",data:{categoryId:$("#dllCategory").val(),keyword:$("#txt-search-keyword").val(),page:system.config.pageIndex,pageSize:system.config.pageSize},url:"/Admin/User/GetAllPaging",dataType:"json",success:function(e){if(e.RowCount>0){let o=$("#table-template").html(),a="";$.each(e.Results,(function(i,r){a+=Mustache.render(o,{Id:r.Id,UserName:r.UserName,FullName:r.FullName,Avatar:null===r.Avatar?'<img src="/admin-site/images/notfound.png" width="25">':'<img src="/admin-site/images/test.jpg" width="25">',DateCreated:system.dateTimeFormatJson(r.DateCreated),Status:system.getStatus(r.Status)}),""!==a&&$("#tbl-content").html(a),function(t,e,n){let o=Math.ceil(t/system.config.pageSize);0!==$("#paginationUL a").length&&!0!==n||($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:o,visiblePages:10,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(t,n){system.config.pageIndex=n,setTimeout(e(),200)}})}(e.RowCount,(function(){n()}),t)}))}else $("#tbl-content").html("");$("#lbl-total-records").text(e.RowCount)},error:function(t){console.log(t),system.notify("Không nạp được dữ liệu","error")}})}function o(t){$.ajax({url:"/Admin/Role/GetAll",type:"GET",dataType:"json",success:function(e){let n=$("#role-template").html(),o=e,a="";$.each(o,(function(e,o){let i="";void 0!==t&&-1!==t.indexOf(o.Name)&&(i="checked"),a+=Mustache.render(n,{Name:o.Name,Description:o.Description,Checked:i})})),$("#list-roles").html(a)}})}this.initialize=function(){n(),$("#frmEdit").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtFullName:{required:!0},txtUserName:{required:!0},txtPassword:{required:!0,minlength:6},txtConfirmPassword:{equalTo:"#txtPassword"},txtEmail:{required:!0,email:!0}}}),$("#txt-search-keyword").on("keypress",(function(t){13===t.which&&(t.preventDefault(),n())})),$("#btnSearch").on("click",(function(){n()})),$("#ddl-show-page").on("change",(function(){system.config.pageSize=$(this).val(),system.config.pageIndex=1,n(!0)})),$("#btnCreateUser").on("click",(function(){e(),o(),$("#modalAddEdit").modal("show")})),$("body").on("click",".btn-edit",(function(e){e.preventDefault();let n=$(this).data("id");$.ajax({url:"/Admin/User/GetById",type:"GET",data:{id:n},dataType:"json",success:function(e){let n=e;$("#hidIdM").val(n.Id),$("#txtFullName").val(n.FullName),$("#txtUserName").val(n.UserName),$("#txtEmail").val(n.Email),$("#txtPhoneNumber").val(n.PhoneNumber),$("#ckStatus").prop("checked",1===n.Status),o(n.Roles),t(!0),$("#modalAddEdit").modal("show")},error:function(){system.notify("Có lỗi khi load dữ liệu !","error")}})})),$("#btnSave").on("click",(function(t){if($("#frmEdit").valid()){t.preventDefault();let o=$("#hidIdM").val(),a=$("#txtFullName").val(),i=$("#txtUserName").val(),r=$("#txtEmail").val(),l=$("#txtPhoneNumber").val(),c=$("#txtPassword").val(),s=[];$.each($('input[name="ckRoles"]'),(function(t,e){!0===$(e).prop("checked")&&s.push($(e).prop("value"))}));let d=!0===$("#ckStatus").prop("checked")?1:0;$.ajax({url:"/Admin/User/SaveEntity",type:"POST",data:{Id:o,FullName:a,UserName:i,Password:c,Email:r,PhoneNumber:l,Status:d,Roles:s},dataType:"json",success:function(){system.notify("Cập nhật dữ liệu thành công","success"),$("#modalAddEdit").modal("hide"),e(),n(!0)},error:function(){system.notify("Có lỗi khi cập nhật dữ liệu !","error")}})}})),$("body").on("click",".btn-delete",(function(t){t.preventDefault();let e=$(this).data("id");system.confirm("Bạn có muốn xóa ?",(function(){$.ajax({url:"/Admin/User/Delete",type:"POST",data:{id:e},success:function(){system.notify("Xóa thành công","success"),n(!0)},error:function(){system.notify("Có lỗi khi xóa !","error")}})}))}))}};